#! /bin/sh
# (C) 2004, 2019 Matthias Andree, GNU GPLv2

# This script updates the bogofilter web directory on sourceforge.

# Theory: check out everything into a staging directory, web,
# then rsync the relevant part into htdocs

# WARNING: Do not edit this file on sourceforge.net directly,
# but rather check out the source code, edit in web/updateweb,
# and commit.

: ${SF_USER:=$(cat ~/.sfuser)}
: ${ROOTSRV:=$(cat ~/.rootsrv 2>/dev/null)}

set -e
umask 02

cd "$(dirname "$0")"

trap 'echo "### FAILED ###" >&2 ; exit 1' 0

if test "x$SF_USER" = x ; then
	echo >&2 "### SF_USER NOT FOUND ###"
	echo >&2 "Put your sourceforge.net username either in the file $HOME/.sfuser or"
	echo >&2 "in the environment variable SF_USER"
	exit 1
fi

echo "==> CHECKING OUT WEB, FAQ, AND NEWS"
URL="http://svn.code.sf.net/p/bogofilter/code/trunk/"
CMD="git"

FILES=$( cd ../bogofilter/doc ; ls bogofilter-faq.html bogofilter-faq-??.html bogofilter-faq-??.xhtml)
(cd ../bogofilter && git archive HEAD $(printf '%s\n' "$FILES" | sed 's}^}doc/}g') \
  NEWS NEWS.0 ) | pax -rdv -s '}doc/}}g'

# check if no uncommitted files are there
a=$($CMD status --porcelain=v1)
if test "x$a" != x && test -z "$PERMIT_UNCOMMITTED" ; then
	echo >&2 "### UNCOMMITTED FILES PERSIST IN LOCAL DIRECTORY - COMMIT FIRST ###"
	printf >&2 '%s\n' "$a"
	exit 1
fi

echo "==> UPLOADING TO web.sourceforge.net:htdocs/"
# copy without cruft and internal files
rsync -acvH \
	--chmod=ug=rwX,o=rX \
	--delete \
	--delete-excluded \
	--exclude '.nfs*' \
	--exclude .svn \
	--exclude README_BEFORE_EDITING \
	--exclude updateweb \
	--exclude '*~' --exclude '*.bak' \
	--exclude '.*.swp' --exclude '#*#' \
	./  \
	$SF_USER,bogofilter@web.sourceforge.net:htdocs/

if test -n "$ROOTSRV" ; then
    echo "==> UPLOADING TO $ROOTSRV"
    # copy without cruft and internal files
    rsync -acvH \
	    --chmod=ug=rwX,o=rX \
	    --delete \
	    --delete-excluded \
	    --exclude '.nfs*' \
	    --exclude .svn \
	    --exclude README_BEFORE_EDITING \
	    --exclude updateweb \
	    --exclude '*~' --exclude '*.bak' \
	    --exclude '.*.swp' --exclude '#*#' \
	    ./  \
	    $ROOTSRV://usr/local/www/bogofilter.org/
fi

echo "==> DONE"
trap 0
